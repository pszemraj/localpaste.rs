name: workflow-lint

on:
  pull_request:
    paths:
    - ".github/workflows/*.yml"
    - ".github/workflows/*.yaml"
    - ".github/scripts/*.py"
  push:
    branches:
    - main
    paths:
    - ".github/workflows/*.yml"
    - ".github/workflows/*.yaml"
    - ".github/scripts/*.py"
  workflow_dispatch:


permissions:
  contents: read

jobs:
  lint-workflows:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install workflow lint dependencies
      shell: bash
      run: |
        set -euo pipefail
        python -m pip install --upgrade pip
        python -m pip install pyyaml yamllint

    - name: Install actionlint
      shell: bash
      run: |
        set -euo pipefail
        curl -sSL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash \
          | bash -s -- -b /usr/local/bin v1.7.11

    - name: Run actionlint
      shell: bash
      run: |
        set -euo pipefail
        actionlint

    - name: Run workflow validation script
      shell: bash
      run: |
        set -euo pipefail
        python .github/scripts/validate_workflow.py .github/workflows
